@model List<DEPI_Donation.Models.Donation>

<h2>Donation List</h2>
<a href="@Url.Action("Create", "Donations")" class="btn btn-primary">Add Donation</a>

<table class="table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>Donor</th>
            <th>Payment</th>
            <th>Activity</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var donation in Model)
        {
            var formattedDate = donation.DonationDate.HasValue
            ? donation.DonationDate.Value.ToString("yyyy-MM-dd")
            : "";

            <tr id="donation-@donation.DonationId">
                <td>@donation.DonationId</td>
                <td>@donation.Donor?.UserName</td>
                <td>@donation.Payment?.PaymentMethod</td>
                <td>@donation.Activity?.Title</td>
                <td>@donation.Amount</td>
                <td>@donation.DonationDate?.ToShortDateString()</td>
                <td>
                    <span class="badge
                        @(donation.Status == DonationStatusType.Canceled ? "bg-danger" :
                          donation.Status == DonationStatusType.Confirmed ? "bg-success" :
                          "bg-warning text-dark")">
                        @donation.Status
                    </span>
                </td>
                <td>
                    @if (donation.Status == DonationStatusType.Pending)
                    {
                        <button class="btn btn-sm btn-danger cancel-btn" data-id="@donation.DonationId">Cancel</button>
                        <button class="btn btn-sm btn-success approve-btn" data-id="@donation.DonationId">Approve</button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
                   $(function () {
            // Cancel button action
            $('.cancel-btn').click(function () {
                var id = $(this).data('id');
                if (confirm('Are you sure you want to cancel this donation?')) {
                    $.ajax({
                        url: '/Donations/Cancel',
                        type: 'POST',
                        data: { id: id },
                        success: function (response) {
                            if (response.success) {
                                var row = $('#donation-' + id);
                                row.find('.badge').removeClass('bg-warning').addClass('bg-danger').text('Canceled').css('color', 'white'); // تغيير اللون للنص الأبيض
                                row.find('.cancel-btn, .approve-btn').hide(); 
                            } else {
                                alert('Cancellation failed: ' + response.message);
                            }
                        },
                        error: function () {
                            alert('An error occurred.');
                        }
                    });
                }
            });

            // Approve button action
            $('.approve-btn').click(function () {
                var id = $(this).data('id');
                if (confirm('Are you sure you want to approve this donation?')) {
                    $.ajax({
                        url: '/Donations/Approve',
                        type: 'POST',
                        data: { id: id },
                        success: function (response) {
                            if (response.success) {
                                var row = $('#donation-' + id);
                                row.find('.badge').removeClass('bg-warning').addClass('bg-success').text('Confirmed').css('color', 'white'); // تغيير اللون للنص الأبيض
                                row.find('.cancel-btn, .approve-btn').hide(); 
                            } else {
                                alert('Approval failed: ' + response.message);
                            }
                        },
                        error: function () {
                            alert('An error occurred.');
                        }
                    });
                }
            });
        });

    </script>
}
